function header () {
  if hash cowsay 2>&-; then
    cowsay -f unipony-smaller $1
  else
    echo
    echo "=== $1 ==="
    echo
  fi
}

function run_suite () {
  case $1 in
    rspec)
      header "rSpec"
      bundle exec rspec --color ./spec
      ;;
    jasmine)
      header "Jasmine"
      xvfb-run bundle exec guard-jasmine
      ;;
    cucumber)
      header "Cucumber (non-javascript)"
      bundle exec cucumber --profile ci -t ~@javascript features
      ;;
    chrome)
      header "Cucumber with chrome"
      CAPYBARA_CHROME=yes bundle exec cucumber --profile ci -t @javascript features
      ;;
    firefox)
      header "Cucumber with firefox"
      bundle exec cucumber --profile ci -t @javascript features
      ;;
    all)
      # skipping Firefox because travis kills (it)
      # "firefox"
      run_suites "rspec" "jasmine" "cucumber" "chrome"
  esac
}

function run_suites () {
  ret=$((0))

  exp=2
  for flavor in "$@"
  do
    time run_suite $flavor || ret=$(($ret+$exp))
    exp=$(($exp*2))
  done

  return $ret
}

function build () {
  if [ $# -gt 0 ]
  then
    run_suites "$@"
  else
    run_suite "all"
  fi
  return $?
}
