From cc37c4911e736df2ab55bee6e284961101dfb19f Mon Sep 17 00:00:00 2001
From: Clemens Kofler and Sven Fuchs <dev+clemens+sven@adva-cms.org>
Date: Tue, 3 Nov 2009 15:05:47 +0100
Subject: [PATCH] fix mergeconflicts

---
 config/initializers/asset_expansions.rb       |    1 +
 features/managing_shifts.feature              |   30 +++++++++++++-----------
 features/step_definitions/shift_steps.rb      |   25 ++++++++++++++++++++
 public/javascripts/shiftplan/plan/employee.js |   13 +++++++---
 public/javascripts/shiftplan/plan/shift.js    |   10 ++++----
 5 files changed, 56 insertions(+), 23 deletions(-)

diff --git a/config/initializers/asset_expansions.rb b/config/initializers/asset_expansions.rb
index 77eb3c8..a3dc2f6 100644
--- a/config/initializers/asset_expansions.rb
+++ b/config/initializers/asset_expansions.rb
@@ -7,6 +7,7 @@ ActionView::Helpers::AssetTagHelper.module_eval do
     lib/jquery/jquery
     lib/jquery/jquery-ui
     lib/jquery/jquery-plugin-form
+    lib/jquery/jquery-plugin-simulate
 
     shiftplan/cursor
     shiftplan/resource
diff --git a/features/managing_shifts.feature b/features/managing_shifts.feature
index 01625a2..d6ddbcc 100644
--- a/features/managing_shifts.feature
+++ b/features/managing_shifts.feature
@@ -100,24 +100,24 @@ Feature: THE plan
 		And I drop onto the plan area
 		Then I should not see a shift "Kitchen" on Monday
 		And there should not be a shift "Kitchen" on Monday stored in the database
-		
+
 	Scenario: Adding a requirement to a shift
 		Given I am on the plan show page
-		When I drag the qualification "Chef" 
+		When I drag the qualification "Chef"
 		And I drop onto to the shift "Bar" on Monday
 		Then I should see a requirement for a "Chef" in the shift "Bar" on Monday
 		And there should be a requirement for a "Chef" in the shift "Bar" on Monday stored in the database
-	
+
 	Scenario: Removing an existing requirement from a shift
 		Given I am on the plan show page
 		When I drag the requirement for a "Barkeeper" from the shift "Bar" on Monday
 		And I drop onto the plan area
 		Then I should not see a requirement for a "Barkeeper" in the shift "Bar" on Monday
 		And there should not be a requirement for a "Barkeeper" in the shift "Bar" on Monday stored in the database
-		
+
 	Scenario: Removing a new requirement from a shift
 		Given I am on the plan show page
-		When I drag the qualification "Chef" 
+		When I drag the qualification "Chef"
 		And I drop onto to the shift "Bar" on Monday
 		And I drag the requirement for a "Chef" from the shift "Bar" on Monday
 		And I drop onto the plan area
@@ -127,30 +127,32 @@ Feature: THE plan
 	Scenario: Assigning an employee to an existing requirement
 		Given I am on the plan show page
 		When I drag the employee "Laura Kozlowski"
-		And I drop onto the requirement for a "Barkeeper" in the shift "Bar" on Monday
+    Then the shift "Kitchen" on Monday should be marked unsuitable
+    And the shift "Bar" on Monday should not be marked unsuitable
+		When I drop onto the requirement for a "Barkeeper" in the shift "Bar" on Monday
 		And I wait for the animation to finish
 		Then I should see the employee "Laura Kozlowski" assigned to the requirement for a "Barkeeper" in the shift "Bar" on Monday
 		And the assignment of "Laura Kozlowski" to the requirement for a "Barkeeper" in the shift "Bar" on Monday should be stored in the database
-		
+
 	Scenario: Assigning an employee to a new requirement
 		Given I am on the plan show page
-		When I drag the qualification "Chef" 
+		When I drag the qualification "Chef"
 		And I drop onto to the shift "Bar" on Monday
 		And I drag the employee "Laura Kozlowski"
 		And I drop onto the requirement for a "Chef" in the shift "Bar" on Monday
 		And I wait for the animation to finish
 		Then I should see the employee "Laura Kozlowski" assigned to the requirement for a "Chef" in the shift "Bar" on Monday
-		
+
 	Scenario: Removing an existing assignment from an existing requirement
 		Given I am on the plan show page
 		When I drag the assignment of "Clemens Kofler" from the requirement for a "Chef" in the shift "Kitchen" on Monday
 		And I drop onto the plan area
 		Then I should not see the employee "Clemens Kofler" assigned to the requirement for a "Chef" in the shift "Kitchen" on Monday
 		And the assignment of "Clemens Kofler" to the requirement for a "Chef" in the shift "Kitchen" on Monday should not be stored in the database
-		
+
 	Scenario: Removing a new assignment from a new requirement
 		Given I am on the plan show page
-		When I drag the qualification "Chef" 
+		When I drag the qualification "Chef"
 		And I drop onto to the shift "Bar" on Monday
 		And I drag the employee "Laura Kozlowski"
 		And I drop onto the requirement for a "Chef" in the shift "Bar" on Monday
@@ -158,6 +160,6 @@ Feature: THE plan
 		And I drop onto the plan area
 		Then I should not see the employee "Laura Kozlowski" assigned to the requirement for a "Chef" in the shift "Bar" on Monday
 		And the assignment of "Laura Kozlowski" to the requirement for a "Chef" in the shift "Bar" on Monday should not be stored in the database
-		
-		
-		
\ No newline at end of file
+
+
+
diff --git a/features/step_definitions/shift_steps.rb b/features/step_definitions/shift_steps.rb
index 1e02343..d9fcd77 100644
--- a/features/step_definitions/shift_steps.rb
+++ b/features/step_definitions/shift_steps.rb
@@ -49,6 +49,17 @@ When /^I drag the shift "([^\"]*)" on (.*)$/ do |workplace, date|
   drag(element)
 end
 
+When /^I drag the (left|right) resize handle of the shift "([^\"]*)" on (.*) by (\d+) pixels to the (.*)$/ do |position, workplace, date, distance, direction|
+  handle = locate_shift(date, workplace) do
+    locate_element(:class => "resize_handle #{position}")
+  end
+  distance   = -distance if %(left top).include?(direction)
+  direction  = %(top bottom).include?(direction) ? 'dy' : 'dx'
+  javascript = "$('#{handle.css_path}').simulate('drag', { #{direction}: #{distance} });"
+  browser.execute(javascript)
+  # DOESN'T WORK
+end
+
 When /^I drop onto the shifts area for day (.*)$/ do |date|
   element = locate_shifts(date)
   drop(element)
@@ -90,3 +101,17 @@ end
 Then /^there should not be a shift "([^\"]*)" on (.*) stored in the database$/ do |workplace, date|
   find_shift(date, workplace).should be_nil
 end
+
+Then /^the shift "([^\"]*)" on (.*) should be marked unsuitable$/ do |workplace, date|
+  shift = locate_shift(date, workplace)
+  # p shift
+p page.getTitleText
+end
+
+Then /^the shift "([^\"]*)" on (.*) should not be marked unsuitable$/ do |workplace, date|
+  shift = locate_shift(date, workplace)
+  # p shift
+p page.getTitleText
+puts response.body
+end
+
diff --git a/public/javascripts/shiftplan/plan/employee.js b/public/javascripts/shiftplan/plan/employee.js
index 25a2c7d..d3ea2c8 100644
--- a/public/javascripts/shiftplan/plan/employee.js
+++ b/public/javascripts/shiftplan/plan/employee.js
@@ -7,8 +7,13 @@
   	selector: ".employee",
   	on_drag_start: function(event, ui) {
   	  // TODO: should also take into account that the employee might already be assigned to this or another shift
-      // var possible_workplaces = ui.helper.closest('.employee').attr('data-possible-workplaces').split(', ');
-      // $('.shift:not(.' + possible_workplaces.join(', .') + ')').addClass('unsuitable_workplace');
+      var workplaces = ui.helper.closest('.employee').attr('data-possible-workplaces');
+      if(workplaces.length != 0) {
+        workplaces = $.map(workplaces.split(/,\s?/), function(workplace) {
+          return '.' + workplace;
+        });
+        $('.shift:not(' + workplaces.join(',') + ')').addClass('unsuitable_workplace');
+      }
   	},
   	on_drag_stop: function(event, ui) {
   	  $('.unsuitable_workplace').removeClass('unsuitable_workplace');
@@ -17,7 +22,7 @@
 
   Employee.prototype = $.extend(new Resource, {
     init: function() {
-      this.element.prepend('<div></div>')    
+      this.element.prepend('<div></div>')
     },
   	bind_events: function() {
   		$('div', this.element).draggable({
@@ -26,7 +31,7 @@
   			stop: Employee.on_drag_stop
   		});
   	}
-  });  
+  });
 
   Resource.types.push(Employee);
 
diff --git a/public/javascripts/shiftplan/plan/shift.js b/public/javascripts/shiftplan/plan/shift.js
index ccc004a..0910dea 100644
--- a/public/javascripts/shiftplan/plan/shift.js
+++ b/public/javascripts/shiftplan/plan/shift.js
@@ -174,7 +174,7 @@
       var box = this.shiftsDimensions();
       return event.pageX >= box.left && event.pageX <= box.right &&
              event.pageY >= box.top  && event.pageY <= box.bottom
-  	  
+
   	},
   	updateDragMode: function(event) {
       var over = this.isOverShiftsBox(event);
@@ -190,9 +190,9 @@
         this.removing = false;
   	    this.element[0].style.top = '0px';
   	    var draggable = this.draggable();
-  	    $.extend(true, draggable, { 
+  	    $.extend(true, draggable, {
   	      containment: 'parent',
-  	      options: { axis: 'x', grid: Plan.grid } 
+  	      options: { axis: 'x', grid: Plan.grid }
   	    });
   	    draggable._setContainment();
   	    Cursor.hide();
@@ -201,9 +201,9 @@
   	setDragRemoving: function(event) {
   	  if(!this.removing) {
         this.removing = true;
-  	    $.extend(true, this.draggable(), { 
+  	    $.extend(true, this.draggable(), {
   	      containment: null,
-  	      options: { axis: null, grid: null } 
+  	      options: { axis: null, grid: null }
   	    });
         Cursor.show('poof');
       }
-- 
1.6.4.2

